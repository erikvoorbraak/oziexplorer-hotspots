<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Thermal Hotspots to OziExplorer WPT</title>
</head>
<body>
  <h1>Thermal Hotspots to OziExplorer WPT</h1>

  <label>Center Latitude: <input id="centerLat" type="text" value="46.5092063"></label><br>
  <label>Center Longitude: <input id="centerLon" type="text" value="8.0680800"></label><br>
  <label>Radius (km): <input id="radiusKm" type="number" value="50"></label><br><br>

  <button onclick="generateWpt()">Generate WPT file</button>
  <pre id="output"></pre>

  <script>
    function degToRad(degrees) {
      return degrees * Math.PI / 180;
    }

    function computeBoundingBox(lat, lon, radiusKm) {
      const latDeg = radiusKm / 111.0;
      const lonDeg = radiusKm / (111.0 * Math.cos(degToRad(lat)));
      return {
        southLat: lat - latDeg,
        northLat: lat + latDeg,
        westLon: lon - lonDeg,
        eastLon: lon + lonDeg
      };
    }

    async function generateWpt() {
      const centerLat = parseFloat(document.getElementById("centerLat").value);
      const centerLon = parseFloat(document.getElementById("centerLon").value);
      const radiusKm = parseFloat(document.getElementById("radiusKm").value) || 50;

      const bbox = computeBoundingBox(centerLat, centerLon, radiusKm);

      const url = `https://thermal.kk7.ch/api/hotspots/geojson/all_all/${bbox.southLat},${bbox.westLon},${bbox.northLat},${bbox.eastLon}?limit=500`;

      try {
        const response = await fetch(url);
        if (!response.ok) throw new Error("HTTP error " + response.status);
        const data = await response.json();

        let wpt = "";
        // OziExplorer header
        wpt += "OziExplorer Waypoint File Version 1.1\n";
        wpt += "WGS 84\n";
        wpt += "Reserved 2\n";
        wpt += "Reserved 3\n";

        const features = data.features;
        for (let i = 0; i < features.length; i++) {
          const feature = features[i];
          const coords = feature.geometry.coordinates;
          const lon = coords[0];
          const lat = coords[1];
          const name = `HS${String(i+1).padStart(2,'0')}`;
          wpt += `${i+1},${name},${lat.toFixed(7)},${lon.toFixed(7)},,0,1,3,0,65535,${name},0,0,100,0,6,0,17\n`;
        }

        document.getElementById("output").textContent = wpt;
        downloadFile("hotspots.wpt", wpt);
      } catch (err) {
        console.error(err);
        alert("Error: " + err);
      }
    }

    function downloadFile(filename, content) {
      const blob = new Blob([content], { type: 'text/plain' });
      const link = document.createElement("a");
      link.href = URL.createObjectURL(blob);
      link.download = filename;
      link.click();
    }
  </script>
</body>
</html>
